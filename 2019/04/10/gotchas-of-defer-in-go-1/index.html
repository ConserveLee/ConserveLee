<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="lee"><link rel="alternative" href="/atom.xml" title="I'm lee" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>5ä¸ªGoçš„deferé™·é˜± - I'm lee</title>
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]-->
<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/fancybox/jquery.fancybox.min.js"></script>
<meta name="generator" content="Hexo 4.2.0"></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">I'm lee</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/tags">æ ‡ç­¾</a></li><li class="head-nav__item"><a class="head-nav__link" href="/archives">ç›®å½•</a></li><li class="head-nav__item"><a class="head-nav__link" href="/about">å…³äºæˆ‘</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-04-10T04:16:25.000Z">2019 - 04 - 10 04:16:25</time><h1 class="post__title"><a href="/2019/04/10/gotchas-of-defer-in-go-1/">5ä¸ªGoçš„deferé™·é˜±</a></h1><div class="post__main echo"><h2 id="1-nil-å‡½æ•°-Defer"><a href="#1-nil-å‡½æ•°-Defer" class="headerlink" title="1  - nil å‡½æ•° Defer"></a>1  - nil å‡½æ•° Defer</h2><p>å½“åœ¨è¿”å›ä¸º nil çš„å‡½æ•°ä¸­ä½¿ç”¨ deferï¼Œå½“è°ƒç”¨ defer æ—¶ï¼ŒåŒ…å« defer çš„å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ä¼šæŠ›å‡º <a href="https://golang.org/ref/spec#Handling_panics" target="_blank" rel="noopener">panics</a>ã€‚</p>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> run <span class="function"><span class="keyword">func</span><span class="params">()</span> = <span class="title">nil</span></span></span><br><span class="line">  <span class="keyword">defer</span> run()</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">"runs"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è¾“å‡º"><a href="#è¾“å‡º" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runs</span><br><span class="line"></span><br><span class="line">â—ï¸ <span class="built_in">panic</span>: runtime error: invalid memory address or <span class="literal">nil</span> pointer dereference</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ºä»€ä¹ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆï¼Ÿ</h3><blockquote>
<p> åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå‡½æ•°ä¸€ç›´æŒç»­åˆ°ç»“æŸï¼Œåœ¨å‡½æ•°è¿è¡Œ defer ä¹‹åä¼šå› ç‚ºå‡½æ•°ä¸ºé›¶å€¼è€ŒæŠ›å‡º panicã€‚ ä½†æ˜¯ï¼Œ <code>run()</code> å‡½æ•°å¯ä»¥æˆåŠŸæ³¨å†Œï¼Œå› ä¸ºåœ¨åŒ…å«å®ƒçš„å‡½æ•°ç»“æŸä¹‹å‰ä¸ä¼šè¢«è°ƒç”¨ã€‚ </p>
<p> è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½†åŒæ ·çš„äº‹æƒ…å¯èƒ½å‘ç”Ÿåœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ é‡åˆ°ç±»ä¼¼çš„æƒ…å†µï¼Œé‚£å¯èƒ½æ˜¯åŒæ ·çš„é—®é¢˜ã€‚ </p>
</blockquote>
<h2 id="2-å¾ªç¯ä¸­-defer"><a href="#2-å¾ªç¯ä¸­-defer" class="headerlink" title="2  - å¾ªç¯ä¸­ defer"></a>2  - å¾ªç¯ä¸­ defer</h2><p> ä¸è¦åœ¨å¾ªç¯ä¸­ä½¿ç”¨ deferï¼Œé™¤éä½ ç¡®å®šè‡ªå·±åœ¨åšä»€ä¹ˆã€‚ å®ƒå¯èƒ½æ— æ³•æŒ‰è®¾æƒ³è¿è¡Œã€‚ </p>
<p> ä½†æ˜¯ï¼Œæœ‰æ—¶åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer ä¼šå¾ˆæ–¹ä¾¿ï¼Œä¾‹å¦‚ï¼Œå°†å‡½æ•°çš„é€’å½’äº¤çµ¦ deferï¼Œä½†æ˜¯è¿™è¶…å‡ºäº†æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ã€‚ </p>
<p><img src="http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/1.png" alt="img"></p>
<blockquote>
<p> åœ¨å‡½æ•°ä¸­ <code>defer row.Close()</code> ç›´åˆ°å‡½æ•°çµæŸä¸ä¼šæ‰§è¡Œ - è€Œä¸æ˜¯åœ¨æ¯æ¬¡forå¾ªç¯çš„çµæŸæ—¶æ‰§è¡Œã€‚ è¿™é‡Œçš„æ‰€æœ‰ defer éƒ½ä¼šå ç”¨å‡½æ•°çš„å †ç©ºé—´ï¼Œå¹¶å¯èƒ½ä¼šå¯¼è‡´æ— æ³•é¢„æ–™çš„é—®é¢˜ã€‚ </p>
</blockquote>
<h3 id="è§£æ±ºæ–¹æ¡ˆ1ï¼š"><a href="#è§£æ±ºæ–¹æ¡ˆ1ï¼š" class="headerlink" title="è§£æ±ºæ–¹æ¡ˆ1ï¼š"></a>è§£æ±ºæ–¹æ¡ˆ1ï¼š</h3><p> ç›´æ¥è°ƒç”¨ã€‚ </p>
<p><img src="http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/2.png" alt="img"></p>
<h3 id="è§£æ±ºæ–¹æ¡ˆ2ï¼š"><a href="#è§£æ±ºæ–¹æ¡ˆ2ï¼š" class="headerlink" title="è§£æ±ºæ–¹æ¡ˆ2ï¼š"></a>è§£æ±ºæ–¹æ¡ˆ2ï¼š</h3><p> å°†å·¥ä½œå§”æ‰˜ç»™å¦ä¸€ä¸ªå‡½æ•°å¹¶åœ¨é‚£é‡Œä½¿ç”¨deferã€‚ è¿™é‡Œï¼Œdefer å°†åœ¨æ¯æ¬¡åŒ¿åå‡½æ•°ç»“æŸåè¿è¡Œã€‚ </p>
<p><img src="http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/3.png" alt="img"></p>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><blockquote>
<p>æˆ‘å¯¹å¾ªç¯ä¸­ä½¿ç”¨ defer è¿›è¡Œäº†åŸºå‡†æµ‹è¯•.  #golang Oh boy, defer is hungry. </p>
<p><a href="https://t.co/WcEoojVeKq" target="_blank" rel="noopener">https://t.co/WcEoojVeKq</a></p>
<p>â€”â€Š@inancgumus</p>
</blockquote>
<center>ğŸ‘¾ç¤ºä¾‹ä»£ç åœ¨ [**è¿™é‡Œ**](https://play.golang.org/p/GJ7oOMdBwJ) **ğŸ‘¾** </center>



<h2 id="3-åŒ…è£…ä¸­çš„-defer"><a href="#3-åŒ…è£…ä¸­çš„-defer" class="headerlink" title="3  - åŒ…è£…ä¸­çš„ defer"></a>3  - åŒ…è£…ä¸­çš„ defer</h2><p> æœ‰æ—¶å€™ä½ éœ€è¦ defer ä¸€ä¸ªé—­åŒ…ä¸ºäº†è®©å®ƒæ›´å¥½ç”¨æˆ–å› ä¸ºä¸€äº›å…¶ä»–æˆ‘ä¸èƒ½é¢„æµ‹çš„åŸå› ã€‚ ä¾‹å¦‚ï¼Œè¿æ¥æ•°æ®åº“ï¼Œç„¶åè¿è¡ŒæŸ¥è¯¢ï¼Œæœ€åç¡®ä¿æ–­å¼€è¿æ¥ã€‚ </p>
<h3 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> database <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *database)</span> <span class="title">connect</span><span class="params">()</span> <span class="params">(disconnect <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">"connect"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"disconnect"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db := &amp;database&#123;&#125;</span><br><span class="line"><span class="keyword">defer</span> db.connect()</span><br><span class="line"> </span><br><span class="line">fmt.Println(<span class="string">"query db..."</span>)</span><br></pre></td></tr></table></figure>

<h3 id="è¾“å‡º-1"><a href="#è¾“å‡º-1" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query db...</span><br><span class="line">connect</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ</h3><p> è¿™ä¸ªç¤ºä¾‹æ²¡æœ‰æ­£å¸¸è¿æ¥å¹¶æ–­å¼€ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª bugã€‚ è¿™é‡Œ <code>connect()</code> è¢«ä¿å­˜äº†èµ·æ¥ï¼Œç›´åˆ°å‡½æ•°ç»“æŸä¹Ÿæ²¡æœ‰è¿è¡Œã€‚ </p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  db := &amp;database&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">close</span> := db.connect()</span><br><span class="line">  <span class="keyword">defer</span> <span class="built_in">close</span>()</span><br><span class="line"> </span><br><span class="line">  fmt.Println(<span class="string">"query db..."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> è¿™é‡Œ <code>db.connect()</code>è¿”å›ä¸€å€‹å‡½æ•°ï¼Œå½“æ•´ä¸ªå‡½æ•°ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥å»¶è¿Ÿæ–­å¼€ä¸æ•°æ®åº“çš„è¿æ¥ã€‚ </p>
<h3 id="è¾“å‡º-2"><a href="#è¾“å‡º-2" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connect</span><br><span class="line">query db...</span><br><span class="line">disconnect</span><br></pre></td></tr></table></figure>



<h3 id="ä¸å¥½çš„åšæ³•ï¼š"><a href="#ä¸å¥½çš„åšæ³•ï¼š" class="headerlink" title="ä¸å¥½çš„åšæ³•ï¼š"></a><strong>ä¸å¥½çš„åšæ³•ï¼š</strong></h3><p> è™½ç„¶è¿™æ˜¯ä¸å¥½çš„åšæ³•ï¼Œä½†æˆ‘æƒ³å‘Šè¯‰ä½ å¦‚ä½•åœ¨æ²¡æœ‰å˜é‡çš„æƒ…å†µä¸‹åšåˆ°è¿™ä¸€ç‚¹ã€‚ æ‰€ä»¥ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½çœ‹åˆ° defer å’Œ Go é€šå¸¸æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  db := &amp;database&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">defer</span> db.connect()()</span><br><span class="line"></span><br><span class="line">  ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> è¿™æ®µä»£ç åœ¨æŠ€æœ¯ä¸Šä¸ä¸Šä¸ªè§£å†³æ–¹æ¡ˆå‡ ä¹ç›¸åŒã€‚ è¿™é‡Œï¼Œç¬¬ä¸€ä¸ªæ‹¬å·ç”¨äºè¿æ¥æ•°æ®åº“ï¼ˆ <em>åœ¨</em> <code>*defer db.connect()*</code> <em>ä¸Šç«‹å³æ‰§è¡Œ</em> ï¼‰ ï¼Œç„¶åç¬¬äºŒä¸ªæ‹¬å·ç”¨äºåœ¨æ•´ä¸ªå‡½æ•°ç»“æŸæ—¶å»¶è¿Ÿè¿è¡Œæ–­å¼€å‡½æ•°ï¼ˆ è¿”å›çš„é—­åŒ…ï¼‰ ã€‚ </p>
<p> å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸º<code>db.connect()</code>åˆ›å»ºäº†ä¸€ä¸ªå€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªå»¶è¿Ÿæ³¨å†Œé—­åŒ…ã€‚ <code>db.connect()</code>çš„å€¼éœ€è¦è¢«è§£æï¼Œå¹¶åœ¨ defer æ—¶æ³¨å†Œã€‚ è¿™ä¸ defer æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä½†å®ƒå¯èƒ½å¯ä»¥è§£å†³ä½ å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚ </p>
<h2 id="4-åœ¨å—ä¸­-defer"><a href="#4-åœ¨å—ä¸­-defer" class="headerlink" title="4  - åœ¨å—ä¸­ defer"></a>4  - åœ¨å—ä¸­ defer</h2><p> æ‚¨å¯èƒ½å¸Œæœ› defer çš„å‡½æ•°å°†åœ¨å—ç»“æŸåè¿è¡Œï¼Œä½†å®ƒä¸ä¼šï¼Œå®ƒåªåœ¨åŒ…å«å®ƒçš„å‡½æ•°ç»“æŸåæ‰§è¡Œã€‚ å¯¹äºæ‰€æœ‰å—ä¹Ÿæ˜¯è¿™æ ·ï¼šåŒ…æ‹¬ forï¼Œswitch ç­‰ï¼Œé™¤äº†æˆ‘ä»¬ä¹‹å‰çš„é™·é˜±ä¸­çœ‹åˆ°çš„å‡½æ•°å—å¤–ã€‚ </p>
<blockquote>
<p> å› ä¸ºï¼šdeferå±äºä¸€ä¸ªå‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªå—ã€‚ </p>
</blockquote>
<h4 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"block: defer runs"</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"block: ends"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">"main: ends"</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è¾“å‡º-3"><a href="#è¾“å‡º-3" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">block: ends</span><br><span class="line">main: ends</span><br><span class="line">block: <span class="keyword">defer</span> runs</span><br></pre></td></tr></table></figure>

<h4 id="è§£é‡Š"><a href="#è§£é‡Š" class="headerlink" title="è§£é‡Š"></a>è§£é‡Š</h4><p> ä¸Šé¢çš„ defer åªä¼šåœ¨å‡½æ•°ç»“æŸæ—¶æ‰ä¼šè¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨ defer å¤–çš„å—ç»“æŸæ—¶ï¼ˆ åŒ…å«å»¶è¿Ÿè°ƒç”¨çš„èŠ±æ‹¬å·å†…çš„åŒºåŸŸï¼‰ ã€‚ å¦‚ç¤ºä¾‹ä»£ç æ‰€ç¤ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·åˆ›å»ºå•ç‹¬çš„å—ã€‚ </p>
<h4 id="å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ"><a href="#å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ"></a>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ</h4><p> å¦‚æœä½ æƒ³åœ¨ä¸€ä¸ªå—ä¸­è¿è¡Œå»¶è¿Ÿï¼Œä½ å¯ä»¥å°†å®ƒè½¬æ¢ä¸ºfuncï¼Œå¦‚åŒ¿åå‡½æ•°ï¼Œå°±åƒ é—®é¢˜2 çš„è§£å†³æ–¹æ¡ˆä¸€æ ·ã€‚ </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"func: defer runs"</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"func: ends"</span>)</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">"main: ends"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-defer-method"><a href="#5-defer-method" class="headerlink" title="5  - defer method"></a>5  - defer method</h2><p> ä½ ä¹Ÿå¯ä»¥å°† <a href="https://blog.learngoprogramming.com/go-functions-overview-anonymous-closures-higher-order-deferred-concurrent-6799008dde7b#61ec" target="_blank" rel="noopener">methods</a> å’Œ defer ä¸€èµ·ä½¿ç”¨ã€‚ è¿™æŒºå¥‡æ€ªçš„ï¼Œ è¯·çœ‹ã€‚ </p>
<h4 id="æ²’æœ‰æŒ‡é‡"><a href="#æ²’æœ‰æŒ‡é‡" class="headerlink" title="æ²’æœ‰æŒ‡é‡"></a>æ²’æœ‰æŒ‡é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">  model <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Car)</span> <span class="title">PrintModel</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(c.model)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := Car&#123;model: <span class="string">"DeLorean DMC-12"</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">defer</span> c.PrintModel()</span><br><span class="line"></span><br><span class="line">  c.model = <span class="string">"Chevrolet Impala"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è¾“å‡º-4"><a href="#è¾“å‡º-4" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeLorean DMC<span class="number">-12</span></span><br></pre></td></tr></table></figure>



<h4 id="ä½¿ç”¨æŒ‡é‡"><a href="#ä½¿ç”¨æŒ‡é‡" class="headerlink" title="ä½¿ç”¨æŒ‡é‡"></a>ä½¿ç”¨æŒ‡é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Car)</span> <span class="title">PrintModel</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(c.model)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è¾“å‡º-5"><a href="#è¾“å‡º-5" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chevrolet Impala</span><br></pre></td></tr></table></figure>



<h4 id="è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ"><a href="#è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ" class="headerlink" title="è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ"></a>è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</h4><p><img src="http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/4.png" alt="img"></p>
<p> è¯·è°¨è®°ï¼Œä¼ é€’ç»™ defer çš„å‚æ•°ä¼šç«‹å³ä¿å­˜åˆ°ä¸€è¾¹ï¼Œè€Œä¸å¿…ç­‰å¾… defer è¿è¡Œã€‚ </p>
<p> å› æ­¤ï¼Œå½“å¸¦æœ‰ä¼ é€’å€¼æ¥æ”¶å™¨çš„æ–¹æ³•ä¸ defer ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ¥æ”¶å™¨å°†åœ¨æ³¨å†Œæ—¶è¢«å¤åˆ¶ï¼ˆ åœ¨æœ¬ä¾‹ä¸­ä¸º<em>Car*ï¼‰ ï¼Œå¹¶ä¸”å¯¹å…¶çš„æ›´æ”¹å°†ä¸å¯è§ï¼ˆ *Car.model</em> ï¼‰ã€‚ å› ä¸ºæ¥æ”¶å™¨ä¹Ÿæ˜¯è¾“å…¥å‚æ•°ï¼Œå¹¶ä¸”å½“å®ƒåœ¨å»¶è¿Ÿæ—¶æ³¨å†Œæ—¶ç«‹å³é‰´å®šä¸ºâ€œDeLorean DMC-12â€ã€‚ </p>
<p> å¦ä¸€æ–¹é¢ï¼Œå½“æ¥æ”¶å™¨æ˜¯æŒ‡é’ˆæ—¶å’Œ defer ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æŒ‡é’ˆï¼Œä½†å®ƒæŒ‡å‘çš„åœ°å€ä¸ä¸Šé¢çš„â€œcâ€æŒ‡é’ˆç›¸åŒã€‚ å› æ­¤ï¼Œå¯¹å®ƒçš„ä»»ä½•æ”¹å˜éƒ½å°†å®Œæ•´åœ°åæ˜ å‡ºæ¥ã€‚ </p>
<hr>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/develop/">develop</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Golang/">Golang</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">æ‰“èµ</a><div class="reward-wrapper clearfix"><img src="/img/wechat.jpg" title="å¾®ä¿¡"></div></section><div class="comments" id="v-container"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/js/Valine.min.js"></script>
<script>new Valine({
  av: AV,
  el: '#v-container',
  app_id: 'Rd0PToFAcsyXLCHl8fqyBeJI-gzGzoHsz',
  app_key: 'ueCzdUwQyXXqfx7OMtdlmjHw',
  avatar: 'wavatar',
  avatarForce: false,
  notify: false,
  verify: false,
  lang: 'zh-cn',
  placeholder: 'ãƒ¾ï¾‰â‰§âˆ€â‰¦)oæ¥å•Šï¼Œå¿«æ´»å•Š!',
  pageSize: 20,
  visitor: true,
  highlight: true,
  emoticon_url: '/img/alu',
  emoticon_list: ["å.png","å–·è¡€.png","ç‹‚æ±—.png","ä¸è¯´è¯.png","æ±—.png","åç­‰.png","çŒ®èŠ±.png","ä¸é«˜å…´.png","ä¸­åˆ€.png","å®³ç¾.png","çš±çœ‰.png","å°çœ¼ç›.png","ä¸­æŒ‡.png","å°´å°¬.png","ç…ä½ .png","æƒ³ä¸€æƒ³.png","ä¸­æª.png","å¾—æ„.png","è‚¿åŒ….png","æ‰‡è€³å…‰.png","äº²äº².png","æƒŠå–œ.png","è„¸çº¢.png","æ— æ‰€è°“.png","ä¾¿ä¾¿.png","æ„¤æ€’.png","èœ¡çƒ›.png","çŒ®é»„ç“œ.png","å†…ä¼¤.png","æŠ•é™.png","è§‚å¯Ÿ.png","çœ‹ä¸è§.png","å‡»æŒ.png","æŠ é¼».png","é‚ªæ¶.png","çœ‹çƒ­é—¹.png","å£æ°´.png","æŠ½çƒŸ.png","é”çœ‰.png","è£…å¤§æ¬¾.png","åèˆŒ.png","æ— å¥ˆ.png","é•¿è‰.png","èµä¸€ä¸ª.png","å‘²ç‰™.png","æ— è¯­.png","é˜´æš—.png","ä¸å‡ºæ‰€æ–™.png","å’½æ°”.png","æœŸå¾….png","é«˜å…´.png","åè¡€å€’åœ°.png","å“­æ³£.png","æ¬¢å‘¼.png","é»‘çº¿.png","å–œæè€Œæ³£.png","å–·æ°´.png","æ·±æ€.png","é¼“æŒ.png","æš—åœ°è§‚å¯Ÿ.png"],
});</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2018 - 2020 lee<a class="icp-a" href="http://beian.miit.gov.cn" target="view_window">ç²¤ICPå¤‡20015271å·</a></div></footer>
<script src="/js/scroller.js"></script>

<script src="/js/main.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":205,"height":410},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>